# 关于rcore第八章利用银行家算法实现死锁检测的过程和反思
[题目链接](https://learningos.github.io/rust-based-os-comp2023/chapter8/5exercise.html)

<br> 这个问题，纠结了比较久，然后也想了很多，最后还是妥协了，记录一下自己的心路历程

<p> 起初在想这个问题的时候，因为使用的是银行家算法，我一直在纠结如何得到这个需求矩阵。然后看了一眼应用程序，发现应用程序中没有对需求矩阵进行直接输入，于是我想唯一的办法就是在线程申请资源的时候动态更新需求矩阵。
<p> 后来加入了分配矩阵和资源剩余矩阵（都储存在进程控制块中），逻辑就是：</p>

+ 在申请资源的时候，先更新需求矩阵，分析死锁与否，然后在线程拿到资源后，再更新分配矩阵和资源剩余矩阵；
+ 在释放资源的时候，同时更新需求矩阵，分配矩阵和资源剩余矩阵
+ 分析死锁时，只分析是否有线程还能够被满足，如果有线程能够被满足，就继续进行下去。如果当所有线程都处于无法被满足状态，那么就发生了死锁。但由于这个过程是动态的（需求矩阵动态变化），因此可能一开始并不能检测到死锁，直到后来才能发现死锁。
<p> 然后我就高高兴兴地进行了测试，发现对于信号量的测试用例ch8_deadlock_sem1，发生了死锁但没检验出来，输出相应数据后发现我实现的算法认为在1，2，3号线程发生死锁时，0号线程可以被满足（尽管当前0号线程的需求是[0,0,0,0],当前剩余的资源也是[0,0,0,0]，也就是还有可以满足的线程可以继续执行）但0号线程在主函数中调用了waitpid()，等1，2，3号线程结束，但在1，2，3号线程发生死锁现象时，他们都认为0号线程可以继续执行到结束，于是没有报告死锁现象。
<p> 然后我关闭了0号线程的死锁检测（就是在分析是否有线程可以被满足时，忽略0号线程）。但此时对于信号量的测试用例ch8_deadlock_sem2发生了错误，没有发生死锁的情况下检测出了死锁。检查相应数据过后，发现了当需要0号线程释放0号信号量以供后面的线程开始执行时，由于忽略了0号线程，那么现在会显示所有的被检测线程都无法被满足。也就是说，关闭了0号线程的检测，就相当于过大了了死锁的检测范围，会把一些没有死锁的情况也判定为死锁。（我尝试修改用户应用程序，在线程执行的函数中加入一条sleep()，等到0号线程将0号信号量释放以后，再执行线程想要执行的内容时，此时就不会检测出死锁，也就是需要0号线程释放的资源在其它线程执行前就已经得到释放了，但考虑到不能修改用户程序，遂作罢）
<p> 然后我就在尝试各种方法去调整，包括但不限于：
  
+ 在关闭了0号线程的死锁检测条件下，采用二次死锁检测（如果第一次检测出死锁，那么该线程会sleep一会儿，之后回来再检测是不是还是死锁，如果还是的话，那就确认为死锁）；
+ 在开启了0号线程的死锁检测条件下，如果检测出的可以满足的线程是0号线程，那么我再去检测一下此时0号线程分配矩阵是不是空，也就是有没有给0号线程分配资源，使得0号线程执行完毕后能够将资源释放，以供后面的线程使用。

<p> 但无论是那种方法，我发现了始终有一个问题就是：

+ 如果开启了0号线程的死锁检测条件，由于我的0号线程会调用waittid，等待其它线程执行完毕，此时如果可以满足的线程只有0号线程，那么我的0号线程未必能够执行到结束从而释放资源，甚至我的0号线程根本就没有资源，而是其它线程之间引发的死锁，这无法由0号线程的结束或者释放资源来解决。（也就是此时我的算法的检测范围，小于实际死锁的范围，有的死锁检测不出来）
+ 如果关闭0号线程的死锁检测条件，由于我的0号线程在一开始会将所有的0号信号量收回，在一段时间后一起释放，目的是为了让其他线程在该时刻之后再执行。但是当其他线程在申请0号信号量时，发现没有能满足的线程，于是报出了死锁。但这个资源，确实需要0号线程来释放。（也就是此时我的算法的检测范围，大于实际死锁的范围，有的不是死锁被认定为死锁）

<p> 如果同时考虑关闭0号线程和0号信号量的死锁检测条件，我觉得这个就和原来的死锁检测的期望差别太大了，可能在这个情况下发生这种现象的是0号线程和0号信号量的问题，在另一种情况下，可能就是i号线程和j号信号量的问题，这个是不能够预测的。

<p> 于是我上网查了一下到底是怎么用银行家算法实现死锁检测的，我得到的答案是：在批处理系统下非常好用，因为你在把程序放进去之前就知道每个程序需要多少资源；但是在目前这个交互性很强，随机度很高的系统上，你无法准确的知道每个线程直到结束前需要多少资源，所以这个算法其实不太能派上用场，所以目前的系统针对死锁检测的算法都是鸵鸟算法。（当然，如果有人确实有更好的思路，还请赐教）

<p> 所以我最后做出了妥协，进行了“面向测试用例编程”，效果拔群。
